{% extends "base.html" %}

{% block title %}Logs de Envio de E-mail - Sistema de Cobranças{% endblock %}

{% block content %}
<h1 class="my-4">Logs de Envio de E-mail</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mt-4">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if logs.items %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Horário</th>
                <th>Remetente</th>
                <th>Destinatário</th>
                <th>Assunto</th>
                <th>Status</th>
                <th>Cliente</th>
                <th>Boleto</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs.items %}
            <tr>
                <td>{{ log.horario_disparo | formatar_horario if log.horario_disparo else 'N/D' }}</td>
                <td>{{ log.email_remetente or 'N/D' }}</td>
                <td>{{ log.email_destinatario or 'N/D' }}</td>
                <td>{{ log.assunto or 'Sem Assunto' }}</td>
                <td>
                    {% if log.status == 'sucesso' %}
                        <span class="badge bg-success">Sucesso</span>
                    {% elif log.status == 'falha_autenticacao' or log.status == 'falha_conexao' or log.status == 'falha_smtp' or log.status == 'falha_dns' or log.status == 'falha_geral' %}
                         <span class="badge bg-danger">Falha</span>
                    {% else %}
                         <span class="badge bg-secondary">{{ log.status or 'Desconhecido' }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.cliente %}
 <a href="{{ url_for('main.view_cliente', public_id=log.cliente.public_id) }}" target="_blank">{{ log.cliente.nome }}</a>
                    {% else %}
                        Cliente Removido
                    {% endif %}
                </td>
                 <td>
                    {% if log.boleto %}
                        <a href="{{ url_for('main.view_cliente', public_id=log.boleto.cliente.public_id) }}#boletos-section">{{ log.boleto.descricao_completa or log.boleto.descricao_base }}</a>
 {% else %}
                        Boleto Removido
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#viewLogModal" data-log-id="{{ log.id }}">
                        Visualizar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Controles de Paginação -->
<nav aria-label="Paginação dos Logs">
    <ul class="pagination justify-content-center">
        {% if logs.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('main.listar_logs_email', page=logs.prev_num) }}" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">&laquo;</span>
        </li>
        {% endif %}

        {% for page in logs.iter_pages() %}
        {% if page %}
            {% if page != logs.page %}
            <li class="page-item"><a class="page-link" href="{{ url_for('main.listar_logs_email', page=page) }}">{{ page }}</a></li>
            {% else %}
            <li class="page-item active" aria-current="page"><span class="page-link">{{ page }}</span></li>
            {% endif %}
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if logs.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('main.listar_logs_email', page=logs.next_num) }}" aria-label="Próxima">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link" aria-hidden="true">&raquo;</span>
        </li>
        {% endif %}
    </ul>
</nav>

{% else %}
<div class="alert alert-info" role="alert">
    Nenhum log de envio de e-mail encontrado.
</div>
{% endif %}

{% endblock %}
{# Fim do bloco content #}

{# O modal agora está fora do bloco content e será incluído no bloco modals do base.html #}
{% block modals %}
{{ super() }} {# Inclui qualquer conteúdo de modal do template base #}
<!-- Modal para Visualizar Log (Conteúdo será carregado via AJAX) -->
<div class="modal fade" id="viewLogModal" tabindex="-1" aria-labelledby="viewLogModalLabel" aria-hidden="true">
                <!-- Conteúdo do log será carregado aqui -->
                 <div id="logDetailsContent">
                    <p>Carregando...</p>
                 </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const viewLogModal = document.getElementById('viewLogModal');
    viewLogModal.addEventListener('show.bs.modal', function (event) {
        // Botão que acionou o modal
        const button = event.relatedTarget;
        // Extrai o ID do log do atributo data-log-id
        const logId = button.getAttribute('data-log-id');
        // Elemento onde o conteúdo do log será carregado
        const modalBodyContent = viewLogModal.querySelector('#logDetailsContent');

        // Carregar conteúdo via AJAX
        modalBodyContent.innerHTML = '<p>Carregando...</p>'; // Mostrar um loader

        fetch(`/logs_email/${logId}/dados_json`)
            .then(response => {
                if (!response.ok) {
                     // Tentar ler como texto para ver a mensagem de erro do servidor
                    return response.text().then(text => {
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data && data.id) { // Check if data exists and has an id property
                    let contentHtml = `\
                        <p><strong>Horário do Disparo:</strong> ${data.horario_disparo || 'N/D'}</p>
                        <p><strong>Status:</strong> <span class="badge bg-${data.status === 'sucesso' ? 'success' : 'danger'}">${data.status || 'N/D'}</span></p>
                        <p><strong>Remetente:</strong> ${data.email_remetente || 'N/D'}</p>
                        <p><strong>Destinatário:</strong> ${data.email_destinatario || 'N/D'}</p>
                        {# A coluna CC só será exibida no modal, não na tabela principal #}
                        ${data.email_cc ? `<p><strong>CC:</strong> ${data.email_cc}</p>` : ''}
                        <p><strong>Assunto:</strong> ${data.assunto || 'Sem Assunto'}</p>
                        <p><strong>Cliente:</strong> ${data.cliente_nome || 'Cliente Removido'}</p>
                         <p><strong>Boleto:</strong> ${data.descricao_completa || data.descricao_base || 'Boleto Removido'} (Vencimento: ${data.data_vencimento || 'N/D'})</p>
                        ${data.detalhes ? `<p><strong>Detalhes:</strong> ${data.detalhes}</p>` : ''}
                        <hr>
                        <h6>Conteúdo do E-mail:</h6>
                        <div class="border p-3" style="max-height: 400px; overflow-y: auto;">${log.mensagem_corpo || 'Conteúdo vazio.'}</div>
                    `; // Note: kept log object for boleto details as it was convenient, but can also use data directly
                    modalBodyContent.innerHTML = contentHtml;
                } else {
                    modalBodyContent.innerHTML = `<p class="text-danger">Erro ao carregar detalhes do log: ${data.message || 'Erro desconhecido'}</p>`;
                    console.error('Erro ao carregar detalhes do log:', data.message);
                }
            })
            .catch(error => {
                modalBodyContent.innerHTML = '<p class="text-danger">Erro de rede ou servidor ao carregar detalhes do log.</p>';
                console.error('Erro na requisição AJAX:', error);
            });
    });
});
</script>
{% endblock %}