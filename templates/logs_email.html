{% extends "base.html" %}

{% block title %}Logs de Envio de E-mail - Sistema de Cobranças{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Logs de Envio de E-mail</h2>
    {# Não há botão de adicionar para logs de email, manter apenas o título #}
</div>
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap4.min.css">
<style>
    #logsEmailTable .actions-col { white-space: nowrap; }
    #logsEmailTable .actions-col .btn { margin: 0 2px; }
</style>
{% endblock %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mt-4">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if logs %} {# Check if logs list is not empty #}
<div class="table-responsive">
    <table id="logsEmailTable" class="table table-striped table-hover table-bordered display" style="width:100%">
        <thead>
            <tr>
                <th>Horário</th>
                <th>Remetente</th>
                <th>Destinatário</th>
                <th>Assunto</th>
                <th>Status</th>
                <th>Cliente</th>
                <th>Boleto</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %} {# Iterate directly over the list #}
            <tr>
                <td>{{ log.horario_disparo | formatar_horario if log.horario_disparo else 'N/D' }}</td>
                <td>{{ log.email_remetente or 'N/D' }}</td>
                <td>{{ log.email_destinatario or 'N/D' }}</td>
                <td>{{ log.assunto or 'Sem Assunto' }}</td>
                <td>
                    {% if log.status == 'sucesso' %}
                        <span class="badge bg-success">Sucesso</span>
                    {% elif log.status == 'falha_autenticacao' or log.status == 'falha_conexao' or log.status == 'falha_smtp' or log.status == 'falha_dns' or log.status == 'falha_geral' %}
                         <span class="badge bg-danger">Falha</span>
                    {% else %}
                         <span class="badge bg-secondary">{{ log.status or 'Desconhecido' }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if log.cliente %}
 <a href="{{ url_for('main.view_cliente', public_id=log.cliente.public_id) }}" target="_blank">{{ log.cliente.nome }}</a>
                    {% else %}
 Cliente Removido
                    {% endif %}
                </td>
                 <td>
                    {% if log.boleto %}
                        <a href="{{ url_for('main.view_cliente', public_id=log.boleto.cliente.public_id) }}#boletos-section">{{ log.boleto.descricao_completa or log.boleto.descricao_base }}</a>
 {% else %}
                        Boleto Removido
 {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#viewLogModal" data-log-id="{{ log.id }}">
                        Visualizar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# Manual pagination removed #}

{% else %}
<div class="alert alert-info" role="alert">
    Nenhum log de envio de e-mail encontrado.
</div>
{% endif %}
{# Fim do bloco content #}

{# O modal agora está fora do bloco content e será incluído no bloco modals do base.html #}
{% block modals %}
{{ super() }} {# Inclui qualquer conteúdo de modal do template base #}

<!-- Modal para Visualizar Log (Conteúdo será carregado via AJAX) -->
<div class="modal fade" id="viewLogModal" tabindex="-1" aria-labelledby="viewLogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> {# Adicionado modal-lg para um modal maior #}
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewLogModalLabel">Detalhes do Log de E-mail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Conteúdo do log será carregado aqui via AJAX -->
                <div id="logDetailsContent">
                    <p>Carregando detalhes do log...</p>
                </div>
            </div>
             <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
             </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // Initialize DataTables
    $('#logsEmailTable').DataTable({
        language: { url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-BR.json" },
        // Add other DataTable options as needed (e.g., columnDefs for sorting)
         columnDefs: [
            { orderable: false, targets: -1 } // Disable sorting on the last column (Ações)
        ]
    });

    // Modal event listener
    const viewLogModal = document.getElementById('viewLogModal');
    viewLogModal.addEventListener('show.bs.modal', function (event) {
        // Botão que acionou o modal
        const button = event.relatedTarget;
        // Extrai o ID do log do atributo data-log-id
        const logId = button.getAttribute('data-log-id');
        // Elemento onde o conteúdo do log será carregado
        const modalBodyContent = document.getElementById('logDetailsContent'); // Use getElementById directly

        // Carregar conteúdo via AJAX
        modalBodyContent.innerHTML = '<p>Carregando...</p>'; // Mostrar um loader

        fetch(`/logs_email/${logId}/dados_json`)
            .then(response => {
                if (!response.ok) {
                    // Tentar ler como texto para ver a mensagem de erro do servidor
                    return response.text().then(text => {
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                    });
                }
                return response.json();
            })
            .catch(error => {
                modalBodyContent.innerHTML = '<p class="text-danger">Erro de rede ou servidor ao carregar detalhes do log.</p>';
                console.error('Erro na requisição AJAX:', error);
            });
        });
    });

    // DataTables Initialization
    if ($('#logsEmailTable').length && $.fn.DataTable) {
        $('#logsEmailTable').DataTable({
            language: { url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/pt-BR.json" },
            // Add other DataTable options as needed (e.g., columnDefs for sorting)
        });
    } else {
        console.error("Tabela ou DataTable não está disponível.");
    };
</script>
{% endblock %}